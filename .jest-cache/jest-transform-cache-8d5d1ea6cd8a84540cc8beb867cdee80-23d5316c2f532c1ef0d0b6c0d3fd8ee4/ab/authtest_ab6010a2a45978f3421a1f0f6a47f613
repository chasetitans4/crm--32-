672a53d0f23264349ebe84266b1a9b8a
"use strict";
// Mock secureStorage
jest.mock('../../utils/secureStorage', ()=>{
    const secureStorage = {
        setJSON: jest.fn(),
        getJSON: jest.fn(),
        removeItem: jest.fn()
    };
    const setItemSecure = jest.fn();
    const setJSONAdvanced = jest.fn();
    const getJSONAdvanced = jest.fn();
    return {
        secureStorage,
        // Legacy convenience exports
        setSecureJSON: secureStorage.setJSON,
        getSecureJSON: secureStorage.getJSON,
        removeSecureItem: secureStorage.removeItem,
        setSecureItemAdvanced: setItemSecure,
        setSecureItem: jest.fn(),
        getSecureItem: jest.fn(),
        // Advanced JSON storage uses isolated mocks so tests don't interfere
        setSecureJSONAdvanced: setJSONAdvanced,
        getSecureJSONAdvanced: getJSONAdvanced
    };
});
Object.defineProperty(exports, "__esModule", {
    value: true
});
const _auth = require("../auth");
const _secureStorage = require("../../utils/secureStorage");
const mockSecureStorage = _secureStorage.secureStorage;
const mockSetJSONAdvanced = _secureStorage.setSecureJSONAdvanced;
const mockGetJSONAdvanced = _secureStorage.getSecureJSONAdvanced;
describe('AuthService', ()=>{
    beforeEach(async ()=>{
        jest.resetAllMocks();
        // Reset auth service state
        await _auth.authService.signOut();
    });
    describe('signUp', ()=>{
        it('should create a new user account', async ()=>{
            const email = 'test@example.com';
            const password = 'password123';
            const userData = {
                name: 'Test User'
            };
            const user = await _auth.authService.signUp(email, password, userData);
            expect(user).toMatchObject({
                email,
                name: 'Test User',
                role: 'user'
            });
            expect(user.id).toBeDefined();
            expect(user.createdAt).toBeDefined();
            expect(mockSetJSONAdvanced).toHaveBeenCalledWith('auth_user', user);
        });
        it('should use email prefix as name when name not provided', async ()=>{
            const email = 'john.doe@example.com';
            const password = 'password123';
            const user = await _auth.authService.signUp(email, password);
            expect(user.name).toBe('john.doe');
        });
        it('should handle signup errors', async ()=>{
            mockSetJSONAdvanced.mockImplementationOnce(()=>{
                throw new Error('Storage error');
            });
            await expect(_auth.authService.signUp('test@example.com', 'password123')).rejects.toThrow('Storage error');
        });
    });
    describe('signIn', ()=>{
        it('should authenticate user with valid credentials', async ()=>{
            const email = 'test@example.com';
            const password = 'password123';
            const user = await _auth.authService.signIn(email, password);
            expect(user).toMatchObject({
                email,
                name: 'test',
                role: 'user'
            });
            expect(user.lastLogin).toBeDefined();
            expect(_auth.authService.isAuthenticated()).toBe(true);
        });
        it('should handle signin errors', async ()=>{
            // Cause secure JSON write to fail
            mockSetJSONAdvanced.mockImplementationOnce(()=>{
                throw new Error('Storage error');
            });
            await expect(_auth.authService.signIn('test@example.com', 'password123')).rejects.toThrow('Storage error');
        });
    });
    describe('signOut', ()=>{
        it('should clear user session', async ()=>{
            // First sign in
            await _auth.authService.signIn('test@example.com', 'password123');
            expect(_auth.authService.isAuthenticated()).toBe(true);
            // Then sign out
            await _auth.authService.signOut();
            expect(_auth.authService.isAuthenticated()).toBe(false);
            expect(_auth.authService.getCurrentUser()).toBeNull();
            expect(mockSecureStorage.removeItem).toHaveBeenCalledWith('auth_user');
        });
    });
    describe('updateProfile', ()=>{
        it('should update user profile when authenticated', async ()=>{
            // First sign in
            await _auth.authService.signIn('test@example.com', 'password123');
            const updates = {
                name: 'Updated Name',
                role: 'admin'
            };
            const updatedUser = await _auth.authService.updateProfile(updates);
            expect(updatedUser.name).toBe('Updated Name');
            expect(updatedUser.role).toBe('admin');
            expect(mockSetJSONAdvanced).toHaveBeenCalledWith('auth_user', updatedUser);
        });
        it('should throw error when not authenticated', async ()=>{
            const updates = {
                name: 'Updated Name'
            };
            await expect(_auth.authService.updateProfile(updates)).rejects.toThrow('No authenticated user');
        });
    });
    describe('hasRole', ()=>{
        it('should validate admin role hierarchy', async ()=>{
            const adminUser = {
                id: '1',
                email: 'admin@example.com',
                name: 'Admin User',
                role: 'admin',
                createdAt: new Date().toISOString()
            };
            // Mock the user via advanced storage and init
            mockGetJSONAdvanced.mockReturnValue(adminUser);
            await _auth.authService.init();
            expect(_auth.authService.hasRole('admin')).toBe(true);
            expect(_auth.authService.hasRole('agent')).toBe(true);
            expect(_auth.authService.hasRole('user')).toBe(true);
        });
        it('should validate agent role hierarchy', async ()=>{
            await _auth.authService.signIn('agent@example.com', 'password123');
            await _auth.authService.updateProfile({
                role: 'agent'
            });
            expect(_auth.authService.hasRole('admin')).toBe(false);
            expect(_auth.authService.hasRole('agent')).toBe(true);
            expect(_auth.authService.hasRole('user')).toBe(true);
        });
        it('should validate user role hierarchy', async ()=>{
            await _auth.authService.signIn('user@example.com', 'password123');
            expect(_auth.authService.hasRole('admin')).toBe(false);
            expect(_auth.authService.hasRole('agent')).toBe(false);
            expect(_auth.authService.hasRole('user')).toBe(true);
        });
        it('should return false when not authenticated', ()=>{
            expect(_auth.authService.hasRole('user')).toBe(false);
        });
    });
    describe('getAccessToken', ()=>{
        it('should return token when authenticated', async ()=>{
            await _auth.authService.signIn('test@example.com', 'password123');
            const token = _auth.authService.getAccessToken();
            expect(token).toEqual(expect.any(String));
            expect(token.length).toBeGreaterThan(0);
        });
        it('should return null when not authenticated', ()=>{
            const token = _auth.authService.getAccessToken();
            expect(token).toBeNull();
        });
    });
    describe('state management', ()=>{
        it('should notify subscribers of state changes', async ()=>{
            const mockCallback = jest.fn();
            const unsubscribe = _auth.authService.subscribe(mockCallback);
            await _auth.authService.signIn('test@example.com', 'password123');
            // Ensure callback was called with the expected initial and updated states
            expect(mockCallback).toHaveBeenCalled();
            unsubscribe();
        });
        it('should handle unsubscribe without errors', ()=>{
            const mockCallback = jest.fn();
            const unsubscribe = _auth.authService.subscribe(mockCallback);
            unsubscribe();
            // Should not throw
            expect(true).toBe(true);
        });
    });
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcY2hhc2VcXERvd25sb2Fkc1xcY3JtICgzMilcXHNyY1xcc2VydmljZXNcXF9fdGVzdHNfX1xcYXV0aC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGF1dGhTZXJ2aWNlLCBBdXRoVXNlciB9IGZyb20gJy4uL2F1dGgnXHJcbmltcG9ydCB7IHNlY3VyZVN0b3JhZ2UsIHNldFNlY3VyZUpTT05BZHZhbmNlZCwgZ2V0U2VjdXJlSlNPTkFkdmFuY2VkIH0gZnJvbSAnLi4vLi4vdXRpbHMvc2VjdXJlU3RvcmFnZSdcclxuXHJcbi8vIE1vY2sgc2VjdXJlU3RvcmFnZVxyXG5qZXN0Lm1vY2soJy4uLy4uL3V0aWxzL3NlY3VyZVN0b3JhZ2UnLCAoKSA9PiB7XHJcbiAgY29uc3Qgc2VjdXJlU3RvcmFnZSA9IHtcclxuICAgIHNldEpTT046IGplc3QuZm4oKSxcclxuICAgIGdldEpTT046IGplc3QuZm4oKSxcclxuICAgIHJlbW92ZUl0ZW06IGplc3QuZm4oKSxcclxuICB9XHJcbiAgY29uc3Qgc2V0SXRlbVNlY3VyZSA9IGplc3QuZm4oKVxyXG4gIGNvbnN0IHNldEpTT05BZHZhbmNlZCA9IGplc3QuZm4oKVxyXG4gIGNvbnN0IGdldEpTT05BZHZhbmNlZCA9IGplc3QuZm4oKVxyXG4gIHJldHVybiB7XHJcbiAgICBzZWN1cmVTdG9yYWdlLFxyXG4gICAgLy8gTGVnYWN5IGNvbnZlbmllbmNlIGV4cG9ydHNcclxuICAgIHNldFNlY3VyZUpTT046IHNlY3VyZVN0b3JhZ2Uuc2V0SlNPTixcclxuICAgIGdldFNlY3VyZUpTT046IHNlY3VyZVN0b3JhZ2UuZ2V0SlNPTixcclxuICAgIHJlbW92ZVNlY3VyZUl0ZW06IHNlY3VyZVN0b3JhZ2UucmVtb3ZlSXRlbSxcclxuICAgIHNldFNlY3VyZUl0ZW1BZHZhbmNlZDogc2V0SXRlbVNlY3VyZSxcclxuICAgIHNldFNlY3VyZUl0ZW06IGplc3QuZm4oKSxcclxuICAgIGdldFNlY3VyZUl0ZW06IGplc3QuZm4oKSxcclxuICAgIC8vIEFkdmFuY2VkIEpTT04gc3RvcmFnZSB1c2VzIGlzb2xhdGVkIG1vY2tzIHNvIHRlc3RzIGRvbid0IGludGVyZmVyZVxyXG4gICAgc2V0U2VjdXJlSlNPTkFkdmFuY2VkOiBzZXRKU09OQWR2YW5jZWQsXHJcbiAgICBnZXRTZWN1cmVKU09OQWR2YW5jZWQ6IGdldEpTT05BZHZhbmNlZCxcclxuICB9XHJcbn0pXHJcblxyXG5jb25zdCBtb2NrU2VjdXJlU3RvcmFnZSA9IHNlY3VyZVN0b3JhZ2UgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIHNlY3VyZVN0b3JhZ2U+XHJcbmNvbnN0IG1vY2tTZXRKU09OQWR2YW5jZWQgPSBzZXRTZWN1cmVKU09OQWR2YW5jZWQgYXMgdW5rbm93biBhcyBqZXN0Lk1vY2tcclxuY29uc3QgbW9ja0dldEpTT05BZHZhbmNlZCA9IGdldFNlY3VyZUpTT05BZHZhbmNlZCBhcyB1bmtub3duIGFzIGplc3QuTW9ja1xyXG5cclxuZGVzY3JpYmUoJ0F1dGhTZXJ2aWNlJywgKCkgPT4ge1xyXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xyXG4gICAgamVzdC5yZXNldEFsbE1vY2tzKClcclxuICAgIC8vIFJlc2V0IGF1dGggc2VydmljZSBzdGF0ZVxyXG4gICAgYXdhaXQgYXV0aFNlcnZpY2Uuc2lnbk91dCgpXHJcbiAgfSlcclxuXHJcbiAgZGVzY3JpYmUoJ3NpZ25VcCcsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgY3JlYXRlIGEgbmV3IHVzZXIgYWNjb3VudCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZW1haWwgPSAndGVzdEBleGFtcGxlLmNvbSdcclxuICAgICAgY29uc3QgcGFzc3dvcmQgPSAncGFzc3dvcmQxMjMnXHJcbiAgICAgIGNvbnN0IHVzZXJEYXRhID0geyBuYW1lOiAnVGVzdCBVc2VyJyB9XHJcblxyXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgYXV0aFNlcnZpY2Uuc2lnblVwKGVtYWlsLCBwYXNzd29yZCwgdXNlckRhdGEpXHJcblxyXG4gICAgICBleHBlY3QodXNlcikudG9NYXRjaE9iamVjdCh7XHJcbiAgICAgICAgZW1haWwsXHJcbiAgICAgICAgbmFtZTogJ1Rlc3QgVXNlcicsXHJcbiAgICAgICAgcm9sZTogJ3VzZXInLFxyXG4gICAgICB9KVxyXG4gICAgICBleHBlY3QodXNlci5pZCkudG9CZURlZmluZWQoKVxyXG4gICAgICBleHBlY3QodXNlci5jcmVhdGVkQXQpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KG1vY2tTZXRKU09OQWR2YW5jZWQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdhdXRoX3VzZXInLCB1c2VyKVxyXG4gICAgfSlcclxuXHJcbiAgICBpdCgnc2hvdWxkIHVzZSBlbWFpbCBwcmVmaXggYXMgbmFtZSB3aGVuIG5hbWUgbm90IHByb3ZpZGVkJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBlbWFpbCA9ICdqb2huLmRvZUBleGFtcGxlLmNvbSdcclxuICAgICAgY29uc3QgcGFzc3dvcmQgPSAncGFzc3dvcmQxMjMnXHJcblxyXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgYXV0aFNlcnZpY2Uuc2lnblVwKGVtYWlsLCBwYXNzd29yZClcclxuXHJcbiAgICAgIGV4cGVjdCh1c2VyLm5hbWUpLnRvQmUoJ2pvaG4uZG9lJylcclxuICAgIH0pXHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc2lnbnVwIGVycm9ycycsIGFzeW5jICgpID0+IHtcclxuICAgICAgbW9ja1NldEpTT05BZHZhbmNlZC5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+IHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N0b3JhZ2UgZXJyb3InKVxyXG4gICAgICB9KVxyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIGF1dGhTZXJ2aWNlLnNpZ25VcCgndGVzdEBleGFtcGxlLmNvbScsICdwYXNzd29yZDEyMycpXHJcbiAgICAgICkucmVqZWN0cy50b1Rocm93KCdTdG9yYWdlIGVycm9yJylcclxuICAgIH0pXHJcbiAgfSlcclxuXHJcbiAgZGVzY3JpYmUoJ3NpZ25JbicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgYXV0aGVudGljYXRlIHVzZXIgd2l0aCB2YWxpZCBjcmVkZW50aWFscycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZW1haWwgPSAndGVzdEBleGFtcGxlLmNvbSdcclxuICAgICAgY29uc3QgcGFzc3dvcmQgPSAncGFzc3dvcmQxMjMnXHJcblxyXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgYXV0aFNlcnZpY2Uuc2lnbkluKGVtYWlsLCBwYXNzd29yZClcclxuXHJcbiAgICAgIGV4cGVjdCh1c2VyKS50b01hdGNoT2JqZWN0KHtcclxuICAgICAgICBlbWFpbCxcclxuICAgICAgICBuYW1lOiAndGVzdCcsXHJcbiAgICAgICAgcm9sZTogJ3VzZXInLFxyXG4gICAgICB9KVxyXG4gICAgICBleHBlY3QodXNlci5sYXN0TG9naW4pLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KGF1dGhTZXJ2aWNlLmlzQXV0aGVudGljYXRlZCgpKS50b0JlKHRydWUpXHJcbiAgICB9KVxyXG5cclxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHNpZ25pbiBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIC8vIENhdXNlIHNlY3VyZSBKU09OIHdyaXRlIHRvIGZhaWxcclxuICAgICAgbW9ja1NldEpTT05BZHZhbmNlZC5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+IHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N0b3JhZ2UgZXJyb3InKVxyXG4gICAgICB9KVxyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIGF1dGhTZXJ2aWNlLnNpZ25JbigndGVzdEBleGFtcGxlLmNvbScsICdwYXNzd29yZDEyMycpXHJcbiAgICAgICkucmVqZWN0cy50b1Rocm93KCdTdG9yYWdlIGVycm9yJylcclxuICAgIH0pXHJcbiAgfSlcclxuXHJcbiAgZGVzY3JpYmUoJ3NpZ25PdXQnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGNsZWFyIHVzZXIgc2Vzc2lvbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8gRmlyc3Qgc2lnbiBpblxyXG4gICAgICBhd2FpdCBhdXRoU2VydmljZS5zaWduSW4oJ3Rlc3RAZXhhbXBsZS5jb20nLCAncGFzc3dvcmQxMjMnKVxyXG4gICAgICBleHBlY3QoYXV0aFNlcnZpY2UuaXNBdXRoZW50aWNhdGVkKCkpLnRvQmUodHJ1ZSlcclxuXHJcbiAgICAgIC8vIFRoZW4gc2lnbiBvdXRcclxuICAgICAgYXdhaXQgYXV0aFNlcnZpY2Uuc2lnbk91dCgpXHJcblxyXG4gICAgICBleHBlY3QoYXV0aFNlcnZpY2UuaXNBdXRoZW50aWNhdGVkKCkpLnRvQmUoZmFsc2UpXHJcbiAgICAgIGV4cGVjdChhdXRoU2VydmljZS5nZXRDdXJyZW50VXNlcigpKS50b0JlTnVsbCgpXHJcbiAgICAgIGV4cGVjdChtb2NrU2VjdXJlU3RvcmFnZS5yZW1vdmVJdGVtKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnYXV0aF91c2VyJylcclxuICAgIH0pXHJcbiAgfSlcclxuXHJcbiAgZGVzY3JpYmUoJ3VwZGF0ZVByb2ZpbGUnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHVwZGF0ZSB1c2VyIHByb2ZpbGUgd2hlbiBhdXRoZW50aWNhdGVkJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBGaXJzdCBzaWduIGluXHJcbiAgICAgIGF3YWl0IGF1dGhTZXJ2aWNlLnNpZ25JbigndGVzdEBleGFtcGxlLmNvbScsICdwYXNzd29yZDEyMycpXHJcblxyXG4gICAgICBjb25zdCB1cGRhdGVzID0geyBuYW1lOiAnVXBkYXRlZCBOYW1lJywgcm9sZTogJ2FkbWluJyB9XHJcbiAgICAgIGNvbnN0IHVwZGF0ZWRVc2VyID0gYXdhaXQgYXV0aFNlcnZpY2UudXBkYXRlUHJvZmlsZSh1cGRhdGVzKVxyXG5cclxuICAgICAgZXhwZWN0KHVwZGF0ZWRVc2VyLm5hbWUpLnRvQmUoJ1VwZGF0ZWQgTmFtZScpXHJcbiAgICAgIGV4cGVjdCh1cGRhdGVkVXNlci5yb2xlKS50b0JlKCdhZG1pbicpXHJcbiAgICAgIGV4cGVjdChtb2NrU2V0SlNPTkFkdmFuY2VkKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnYXV0aF91c2VyJywgdXBkYXRlZFVzZXIpXHJcbiAgICB9KVxyXG5cclxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3Igd2hlbiBub3QgYXV0aGVudGljYXRlZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXBkYXRlcyA9IHsgbmFtZTogJ1VwZGF0ZWQgTmFtZScgfVxyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIGF1dGhTZXJ2aWNlLnVwZGF0ZVByb2ZpbGUodXBkYXRlcylcclxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coJ05vIGF1dGhlbnRpY2F0ZWQgdXNlcicpXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKCdoYXNSb2xlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSBhZG1pbiByb2xlIGhpZXJhcmNoeScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgYWRtaW5Vc2VyOiBBdXRoVXNlciA9IHtcclxuICAgICAgICBpZDogJzEnLFxyXG4gICAgICAgIGVtYWlsOiAnYWRtaW5AZXhhbXBsZS5jb20nLFxyXG4gICAgICAgIG5hbWU6ICdBZG1pbiBVc2VyJyxcclxuICAgICAgICByb2xlOiAnYWRtaW4nLFxyXG4gICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBNb2NrIHRoZSB1c2VyIHZpYSBhZHZhbmNlZCBzdG9yYWdlIGFuZCBpbml0XHJcbiAgICAgIG1vY2tHZXRKU09OQWR2YW5jZWQubW9ja1JldHVyblZhbHVlKGFkbWluVXNlcilcclxuICAgICAgYXdhaXQgYXV0aFNlcnZpY2UuaW5pdCgpXHJcblxyXG4gICAgICBleHBlY3QoYXV0aFNlcnZpY2UuaGFzUm9sZSgnYWRtaW4nKSkudG9CZSh0cnVlKVxyXG4gICAgICBleHBlY3QoYXV0aFNlcnZpY2UuaGFzUm9sZSgnYWdlbnQnKSkudG9CZSh0cnVlKVxyXG4gICAgICBleHBlY3QoYXV0aFNlcnZpY2UuaGFzUm9sZSgndXNlcicpKS50b0JlKHRydWUpXHJcbiAgICB9KVxyXG5cclxuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgYWdlbnQgcm9sZSBoaWVyYXJjaHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGF3YWl0IGF1dGhTZXJ2aWNlLnNpZ25JbignYWdlbnRAZXhhbXBsZS5jb20nLCAncGFzc3dvcmQxMjMnKVxyXG4gICAgICBhd2FpdCBhdXRoU2VydmljZS51cGRhdGVQcm9maWxlKHsgcm9sZTogJ2FnZW50JyB9KVxyXG5cclxuICAgICAgZXhwZWN0KGF1dGhTZXJ2aWNlLmhhc1JvbGUoJ2FkbWluJykpLnRvQmUoZmFsc2UpXHJcbiAgICAgIGV4cGVjdChhdXRoU2VydmljZS5oYXNSb2xlKCdhZ2VudCcpKS50b0JlKHRydWUpXHJcbiAgICAgIGV4cGVjdChhdXRoU2VydmljZS5oYXNSb2xlKCd1c2VyJykpLnRvQmUodHJ1ZSlcclxuICAgIH0pXHJcblxyXG4gICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSB1c2VyIHJvbGUgaGllcmFyY2h5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBhd2FpdCBhdXRoU2VydmljZS5zaWduSW4oJ3VzZXJAZXhhbXBsZS5jb20nLCAncGFzc3dvcmQxMjMnKVxyXG5cclxuICAgICAgZXhwZWN0KGF1dGhTZXJ2aWNlLmhhc1JvbGUoJ2FkbWluJykpLnRvQmUoZmFsc2UpXHJcbiAgICAgIGV4cGVjdChhdXRoU2VydmljZS5oYXNSb2xlKCdhZ2VudCcpKS50b0JlKGZhbHNlKVxyXG4gICAgICBleHBlY3QoYXV0aFNlcnZpY2UuaGFzUm9sZSgndXNlcicpKS50b0JlKHRydWUpXHJcbiAgICB9KVxyXG5cclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIHdoZW4gbm90IGF1dGhlbnRpY2F0ZWQnLCAoKSA9PiB7XHJcbiAgICAgIGV4cGVjdChhdXRoU2VydmljZS5oYXNSb2xlKCd1c2VyJykpLnRvQmUoZmFsc2UpXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKCdnZXRBY2Nlc3NUb2tlbicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHRva2VuIHdoZW4gYXV0aGVudGljYXRlZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgYXdhaXQgYXV0aFNlcnZpY2Uuc2lnbkluKCd0ZXN0QGV4YW1wbGUuY29tJywgJ3Bhc3N3b3JkMTIzJylcclxuXHJcbiAgICAgIGNvbnN0IHRva2VuID0gYXV0aFNlcnZpY2UuZ2V0QWNjZXNzVG9rZW4oKVxyXG4gICAgICBleHBlY3QodG9rZW4pLnRvRXF1YWwoZXhwZWN0LmFueShTdHJpbmcpKVxyXG4gICAgICBleHBlY3QoKHRva2VuIGFzIHN0cmluZykubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMClcclxuICAgIH0pXHJcblxyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCB3aGVuIG5vdCBhdXRoZW50aWNhdGVkJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0b2tlbiA9IGF1dGhTZXJ2aWNlLmdldEFjY2Vzc1Rva2VuKClcclxuICAgICAgZXhwZWN0KHRva2VuKS50b0JlTnVsbCgpXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKCdzdGF0ZSBtYW5hZ2VtZW50JywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBub3RpZnkgc3Vic2NyaWJlcnMgb2Ygc3RhdGUgY2hhbmdlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja0NhbGxiYWNrID0gamVzdC5mbigpXHJcbiAgICAgIGNvbnN0IHVuc3Vic2NyaWJlID0gYXV0aFNlcnZpY2Uuc3Vic2NyaWJlKG1vY2tDYWxsYmFjaylcclxuXHJcbiAgICAgIGF3YWl0IGF1dGhTZXJ2aWNlLnNpZ25JbigndGVzdEBleGFtcGxlLmNvbScsICdwYXNzd29yZDEyMycpXHJcblxyXG4gICAgICAvLyBFbnN1cmUgY2FsbGJhY2sgd2FzIGNhbGxlZCB3aXRoIHRoZSBleHBlY3RlZCBpbml0aWFsIGFuZCB1cGRhdGVkIHN0YXRlc1xyXG4gICAgICBleHBlY3QobW9ja0NhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkKClcclxuXHJcbiAgICAgIHVuc3Vic2NyaWJlKClcclxuICAgIH0pXHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgdW5zdWJzY3JpYmUgd2l0aG91dCBlcnJvcnMnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tDYWxsYmFjayA9IGplc3QuZm4oKVxyXG4gICAgICBjb25zdCB1bnN1YnNjcmliZSA9IGF1dGhTZXJ2aWNlLnN1YnNjcmliZShtb2NrQ2FsbGJhY2spXHJcblxyXG4gICAgICB1bnN1YnNjcmliZSgpXHJcbiAgICAgIC8vIFNob3VsZCBub3QgdGhyb3dcclxuICAgICAgZXhwZWN0KHRydWUpLnRvQmUodHJ1ZSlcclxuICAgIH0pXHJcbiAgfSlcclxufSkiXSwibmFtZXMiOlsiamVzdCIsIm1vY2siLCJzZWN1cmVTdG9yYWdlIiwic2V0SlNPTiIsImZuIiwiZ2V0SlNPTiIsInJlbW92ZUl0ZW0iLCJzZXRJdGVtU2VjdXJlIiwic2V0SlNPTkFkdmFuY2VkIiwiZ2V0SlNPTkFkdmFuY2VkIiwic2V0U2VjdXJlSlNPTiIsImdldFNlY3VyZUpTT04iLCJyZW1vdmVTZWN1cmVJdGVtIiwic2V0U2VjdXJlSXRlbUFkdmFuY2VkIiwic2V0U2VjdXJlSXRlbSIsImdldFNlY3VyZUl0ZW0iLCJzZXRTZWN1cmVKU09OQWR2YW5jZWQiLCJnZXRTZWN1cmVKU09OQWR2YW5jZWQiLCJtb2NrU2VjdXJlU3RvcmFnZSIsIm1vY2tTZXRKU09OQWR2YW5jZWQiLCJtb2NrR2V0SlNPTkFkdmFuY2VkIiwiZGVzY3JpYmUiLCJiZWZvcmVFYWNoIiwicmVzZXRBbGxNb2NrcyIsImF1dGhTZXJ2aWNlIiwic2lnbk91dCIsIml0IiwiZW1haWwiLCJwYXNzd29yZCIsInVzZXJEYXRhIiwibmFtZSIsInVzZXIiLCJzaWduVXAiLCJleHBlY3QiLCJ0b01hdGNoT2JqZWN0Iiwicm9sZSIsImlkIiwidG9CZURlZmluZWQiLCJjcmVhdGVkQXQiLCJ0b0hhdmVCZWVuQ2FsbGVkV2l0aCIsInRvQmUiLCJtb2NrSW1wbGVtZW50YXRpb25PbmNlIiwiRXJyb3IiLCJyZWplY3RzIiwidG9UaHJvdyIsInNpZ25JbiIsImxhc3RMb2dpbiIsImlzQXV0aGVudGljYXRlZCIsImdldEN1cnJlbnRVc2VyIiwidG9CZU51bGwiLCJ1cGRhdGVzIiwidXBkYXRlZFVzZXIiLCJ1cGRhdGVQcm9maWxlIiwiYWRtaW5Vc2VyIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwibW9ja1JldHVyblZhbHVlIiwiaW5pdCIsImhhc1JvbGUiLCJ0b2tlbiIsImdldEFjY2Vzc1Rva2VuIiwidG9FcXVhbCIsImFueSIsIlN0cmluZyIsImxlbmd0aCIsInRvQmVHcmVhdGVyVGhhbiIsIm1vY2tDYWxsYmFjayIsInVuc3Vic2NyaWJlIiwic3Vic2NyaWJlIiwidG9IYXZlQmVlbkNhbGxlZCJdLCJtYXBwaW5ncyI6IjtBQUdBLHFCQUFxQjtBQUNyQkEsS0FBS0MsSUFBSSxDQUFDLDZCQUE2QjtJQUNyQyxNQUFNQyxnQkFBZ0I7UUFDcEJDLFNBQVNILEtBQUtJLEVBQUU7UUFDaEJDLFNBQVNMLEtBQUtJLEVBQUU7UUFDaEJFLFlBQVlOLEtBQUtJLEVBQUU7SUFDckI7SUFDQSxNQUFNRyxnQkFBZ0JQLEtBQUtJLEVBQUU7SUFDN0IsTUFBTUksa0JBQWtCUixLQUFLSSxFQUFFO0lBQy9CLE1BQU1LLGtCQUFrQlQsS0FBS0ksRUFBRTtJQUMvQixPQUFPO1FBQ0xGO1FBQ0EsNkJBQTZCO1FBQzdCUSxlQUFlUixjQUFjQyxPQUFPO1FBQ3BDUSxlQUFlVCxjQUFjRyxPQUFPO1FBQ3BDTyxrQkFB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