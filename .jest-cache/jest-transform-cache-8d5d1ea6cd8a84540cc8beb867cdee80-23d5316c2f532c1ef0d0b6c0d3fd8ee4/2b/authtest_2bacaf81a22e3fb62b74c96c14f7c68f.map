{"version":3,"sources":["C:\\Users\\chase\\Downloads\\crm (32)\\src\\services\\__tests__\\auth.test.ts"],"sourcesContent":["import { authService, AuthUser } from '../auth'\r\nimport { secureStorage } from '../../utils/secureStorage'\r\n\r\n// Mock secureStorage\r\njest.mock('../../utils/secureStorage', () => {\r\n  const secureStorage = {\r\n    setJSON: jest.fn(),\r\n    getJSON: jest.fn(),\r\n    removeItem: jest.fn(),\r\n  }\r\n  const setItemSecure = jest.fn()\r\n  return {\r\n    secureStorage,\r\n    // Named exports used by auth.ts map to the same mocks for compatibility\r\n    setSecureJSON: secureStorage.setJSON,\r\n    getSecureJSON: secureStorage.getJSON,\r\n    removeSecureItem: secureStorage.removeItem,\r\n    setSecureItemAdvanced: setItemSecure,\r\n    setSecureItem: jest.fn(),\r\n    getSecureItem: jest.fn(),\r\n  }\r\n})\r\n\r\nconst mockSecureStorage = secureStorage as jest.Mocked<typeof secureStorage>\r\n\r\ndescribe('AuthService', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks()\r\n    // Reset auth service state\r\n    authService.signOut()\r\n  })\r\n\r\n  describe('signUp', () => {\r\n    it('should create a new user account', async () => {\r\n      const email = 'test@example.com'\r\n      const password = 'password123'\r\n      const userData = { name: 'Test User' }\r\n\r\n      const user = await authService.signUp(email, password, userData)\r\n\r\n      expect(user).toMatchObject({\r\n        email,\r\n        name: 'Test User',\r\n        role: 'user',\r\n      })\r\n      expect(user.id).toBeDefined()\r\n      expect(user.createdAt).toBeDefined()\r\n      expect(mockSecureStorage.setJSON).toHaveBeenCalledWith('auth_user', user)\r\n    })\r\n\r\n    it('should use email prefix as name when name not provided', async () => {\r\n      const email = 'john.doe@example.com'\r\n      const password = 'password123'\r\n\r\n      const user = await authService.signUp(email, password)\r\n\r\n      expect(user.name).toBe('john.doe')\r\n    })\r\n\r\n    it('should handle signup errors', async () => {\r\n      mockSecureStorage.setJSON.mockImplementation(() => {\r\n        throw new Error('Storage error')\r\n      })\r\n\r\n      await expect(\r\n        authService.signUp('test@example.com', 'password123')\r\n      ).rejects.toThrow('Storage error')\r\n    })\r\n  })\r\n\r\n  describe('signIn', () => {\r\n    it('should authenticate user with valid credentials', async () => {\r\n      const email = 'test@example.com'\r\n      const password = 'password123'\r\n\r\n      const user = await authService.signIn(email, password)\r\n\r\n      expect(user).toMatchObject({\r\n        email,\r\n        name: 'test',\r\n        role: 'user',\r\n      })\r\n      expect(user.lastLogin).toBeDefined()\r\n      expect(authService.isAuthenticated()).toBe(true)\r\n    })\r\n\r\n    it('should handle signin errors', async () => {\r\n      // Mock localStorage to throw error\r\n      const originalSetItem = Storage.prototype.setItem\r\n      Storage.prototype.setItem = jest.fn(() => {\r\n        throw new Error('Storage error')\r\n      })\r\n\r\n      await expect(\r\n        authService.signIn('test@example.com', 'password123')\r\n      ).rejects.toThrow('Storage error')\r\n\r\n      Storage.prototype.setItem = originalSetItem\r\n    })\r\n  })\r\n\r\n  describe('signOut', () => {\r\n    it('should clear user session', async () => {\r\n      // First sign in\r\n      await authService.signIn('test@example.com', 'password123')\r\n      expect(authService.isAuthenticated()).toBe(true)\r\n\r\n      // Then sign out\r\n      await authService.signOut()\r\n\r\n      expect(authService.isAuthenticated()).toBe(false)\r\n      expect(authService.getCurrentUser()).toBeNull()\r\n      expect(mockSecureStorage.removeItem).toHaveBeenCalledWith('auth_user')\r\n    })\r\n  })\r\n\r\n  describe('updateProfile', () => {\r\n    it('should update user profile when authenticated', async () => {\r\n      // First sign in\r\n      await authService.signIn('test@example.com', 'password123')\r\n\r\n      const updates = { name: 'Updated Name', role: 'admin' }\r\n      const updatedUser = await authService.updateProfile(updates)\r\n\r\n      expect(updatedUser.name).toBe('Updated Name')\r\n      expect(updatedUser.role).toBe('admin')\r\n      expect(mockSecureStorage.setJSON).toHaveBeenCalledWith('auth_user', updatedUser)\r\n    })\r\n\r\n    it('should throw error when not authenticated', async () => {\r\n      const updates = { name: 'Updated Name' }\r\n\r\n      await expect(\r\n        authService.updateProfile(updates)\r\n      ).rejects.toThrow('No authenticated user')\r\n    })\r\n  })\r\n\r\n  describe('hasRole', () => {\r\n    it('should validate admin role hierarchy', async () => {\r\n      const adminUser: AuthUser = {\r\n        id: '1',\r\n        email: 'admin@example.com',\r\n        name: 'Admin User',\r\n        role: 'admin',\r\n        createdAt: new Date().toISOString(),\r\n      }\r\n\r\n      // Mock the user\r\n      mockSecureStorage.getJSON.mockReturnValue(adminUser)\r\n      authService.init()\r\n\r\n      expect(authService.hasRole('admin')).toBe(true)\r\n      expect(authService.hasRole('agent')).toBe(true)\r\n      expect(authService.hasRole('user')).toBe(true)\r\n    })\r\n\r\n    it('should validate agent role hierarchy', async () => {\r\n      await authService.signIn('agent@example.com', 'password123')\r\n      await authService.updateProfile({ role: 'agent' })\r\n\r\n      expect(authService.hasRole('admin')).toBe(false)\r\n      expect(authService.hasRole('agent')).toBe(true)\r\n      expect(authService.hasRole('user')).toBe(true)\r\n    })\r\n\r\n    it('should validate user role hierarchy', async () => {\r\n      await authService.signIn('user@example.com', 'password123')\r\n\r\n      expect(authService.hasRole('admin')).toBe(false)\r\n      expect(authService.hasRole('agent')).toBe(false)\r\n      expect(authService.hasRole('user')).toBe(true)\r\n    })\r\n\r\n    it('should return false when not authenticated', () => {\r\n      expect(authService.hasRole('user')).toBe(false)\r\n    })\r\n  })\r\n\r\n  describe('getAccessToken', () => {\r\n    it('should return token when authenticated', async () => {\r\n      await authService.signIn('test@example.com', 'password123')\r\n\r\n      const token = authService.getAccessToken()\r\n      expect(token).toBe('mock_access_token')\r\n    })\r\n\r\n    it('should return null when not authenticated', () => {\r\n      const token = authService.getAccessToken()\r\n      expect(token).toBeNull()\r\n    })\r\n  })\r\n\r\n  describe('state management', () => {\r\n    it('should notify subscribers of state changes', async () => {\r\n      const mockCallback = jest.fn()\r\n      const unsubscribe = authService.subscribe(mockCallback)\r\n\r\n      await authService.signIn('test@example.com', 'password123')\r\n\r\n      expect(mockCallback).toHaveBeenCalled()\r\n      const lastCall = mockCallback.mock.calls[mockCallback.mock.calls.length - 1][0]\r\n      expect(lastCall.user).toBeDefined()\r\n      expect(lastCall.loading).toBe(false)\r\n      expect(lastCall.error).toBeNull()\r\n\r\n      unsubscribe()\r\n    })\r\n\r\n    it('should handle subscription cleanup', () => {\r\n      const mockCallback = jest.fn()\r\n      const unsubscribe = authService.subscribe(mockCallback)\r\n\r\n      unsubscribe()\r\n\r\n      // State change should not trigger callback after unsubscribe\r\n      authService.signIn('test@example.com', 'password123')\r\n      expect(mockCallback).not.toHaveBeenCalled()\r\n    })\r\n  })\r\n\r\n  describe('initialization', () => {\r\n    it('should load user from storage on init', () => {\r\n      const storedUser: AuthUser = {\r\n        id: '1',\r\n        email: 'stored@example.com',\r\n        name: 'Stored User',\r\n        role: 'user',\r\n        createdAt: new Date().toISOString(),\r\n      }\r\n\r\n      mockSecureStorage.getJSON.mockReturnValue(storedUser)\r\n\r\n      authService.init()\r\n\r\n      expect(authService.getCurrentUser()).toEqual(storedUser)\r\n      expect(authService.isAuthenticated()).toBe(true)\r\n    })\r\n\r\n    it('should handle invalid stored data gracefully', () => {\r\n      mockSecureStorage.getJSON.mockReturnValue('invalid-data')\r\n\r\n      authService.init()\r\n\r\n      expect(authService.getCurrentUser()).toBeNull()\r\n      expect(authService.isAuthenticated()).toBe(false)\r\n    })\r\n\r\n    it('should handle storage errors gracefully', () => {\r\n      mockSecureStorage.getJSON.mockImplementation(() => {\r\n        throw new Error('Storage error')\r\n      })\r\n\r\n      expect(() => authService.init()).not.toThrow()\r\n      expect(authService.getCurrentUser()).toBeNull()\r\n    })\r\n  })\r\n})"],"names":["jest","mock","secureStorage","setJSON","fn","getJSON","removeItem","setItemSecure","setSecureJSON","getSecureJSON","removeSecureItem","setSecureItemAdvanced","setSecureItem","getSecureItem","mockSecureStorage","describe","beforeEach","clearAllMocks","authService","signOut","it","email","password","userData","name","user","signUp","expect","toMatchObject","role","id","toBeDefined","createdAt","toHaveBeenCalledWith","toBe","mockImplementation","Error","rejects","toThrow","signIn","lastLogin","isAuthenticated","originalSetItem","Storage","prototype","setItem","getCurrentUser","toBeNull","updates","updatedUser","updateProfile","adminUser","Date","toISOString","mockReturnValue","init","hasRole","token","getAccessToken","mockCallback","unsubscribe","subscribe","toHaveBeenCalled","lastCall","calls","length","loading","error","not","storedUser","toEqual"],"mappings":"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"}